<html lang=" en ">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Connel Hooley - Akka Guide</title>
    
    <link rel="stylesheet" href="/assets/css/vendor/normalize.css">
    <link rel="stylesheet" href="/assets/css/vendor/stickyfill.css">
    <link rel="stylesheet" href="/assets/css/site.css">
    
    <link rel="alternate" type="application/rss+xml" title="Connel Hooley" href="/feed.xml">  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#f8bb15">
    <meta name="theme-color" content="#f8bb15">
    
    <!-- Begin Jekyll SEO tag v2.4.0 -->
<meta name="generator" content="Jekyll v3.7.2" />
<meta property="og:title" content="Akka Guide" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Full introductory guide to Akka.NET" />
<meta property="og:description" content="Full introductory guide to Akka.NET" />
<link rel="canonical" href="http://connelhooley.uk/blog/2017/02/21/akka-guide" />
<meta property="og:url" content="http://connelhooley.uk/blog/2017/02/21/akka-guide" />
<meta property="og:site_name" content="Connel Hooley" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-02-21T21:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@connel_dev" />
<meta name="twitter:creator" content="@connel_dev" />
<script type="application/ld+json">
{"description":"Full introductory guide to Akka.NET","@type":"BlogPosting","url":"http://connelhooley.uk/blog/2017/02/21/akka-guide","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://connelhooley.uk/assets/images/logo.png"}},"headline":"Akka Guide","dateModified":"2017-02-21T21:00:00+00:00","datePublished":"2017-02-21T21:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://connelhooley.uk/blog/2017/02/21/akka-guide"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57397582-1', 'auto');
  ga('send', 'pageview');

</script>

</head>
<body id="layout-post">
    <div id="site-header-bar">
    <div id="site-header-bar-inner">
        <div id="site-nav">
            <a id="site-logo" href="/">{C.H}</a>
            <button id="site-nav-mobile-toggler"><i class="fas fa-bars"></i></button>
        </div>
        <nav id="site-nav-links">
            <a class="site-nav-item site-nav-item-post site-nav-item-active" href="/blog/">Blog</a>
            
            
                
                
                
                <a class="site-nav-item site-nav-item-projects" href="/projects/">Projects</a>
                
            
                
                
                
                <a class="site-nav-item site-nav-item-experiences" href="/experience/">Experience</a>
                
            
        </nav>
    </div>
</div>
<main id="site-main">
    <article>
    <header id="post-header">
        <div id="post-header-inner">
            <h1 id="post-header-title" class="post-header-item" itemprop="name headline">Akka Guide</h1>
            
            <div id="post-header-description" class="post-header-item">
                Full introductory guide to Akka.NET
            </div>
            
            
            <div id="post-header-published" class="post-header-item">
                <time datetime="2017-02-21T21:00:00+00:00" itemprop="date">
                    <date class="date" datetime="2017-02-21 21:00:00 +0000"><i class="far fa-calendar-alt"></i>&nbsp;21/02/2017</date>
                </time>
            </div>
            
            
            <div id="post-header-reading-time" class="post-header-item">
                <i class="far fa-clock"></i>&nbsp;Read in under 30  minutes
            </div>
            
            
            
            <div id="post-header-presentation" class="post-header-item">
                <a href="/presentations/akka-guide" target="_BLANK"><i class="fas fa-external-link-alt"></i>&nbsp;Presentation available here</a>
            </div>
            
            
            <div id="post-header-meta" class="post-header-item">
                
<span class="meta-item"><i class="fas fa-code"></i>&nbsp;C#</span>


<span class="meta-item"><i class="fas fa-tag"></i>&nbsp;Akka.NET</span>

            </div>
            
        </div>
    </header>
    
    
    
    
    <div id="post-toolbar" class="sticky">
        <div id="post-toolbar-inner">
            <div id="post-toolbar-buttons">
                <div id="post-toolbar-share-buttons">
                    <span id="post-toolbar-share-buttons-label"><i class="fas fa-share-alt fa-fw"></i>&nbsp;<span class="post-toolbar-button-label">Share&nbsp;</span></span>
                    <a class="post-toolbar-button" target="_BLANK" href="https://twitter.com/intent/tweet?text=Akka+Guide+by+%40connel_dev&url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F02%2F21%2Fakka-guide"><i class="fab fa-twitter-square fa-fw"></i><span class="post-toolbar-button-label">&nbsp;Twitter</span></a>
                    <a class="post-toolbar-button" target="_BLANK" href="//www.reddit.com/submit?url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F02%2F21%2Fakka-guide&title=Akka+Guide"><i class="fab fa-reddit-square fa-fw"></i><span class="post-toolbar-button-label">&nbsp;Reddit</span></a>
                    <a class="post-toolbar-button" target="_BLANK" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F02%2F21%2Fakka-guide&title=Akka+Guide"><i class="fab fa-linkedin fa-fw"></i><span class="post-toolbar-button-label">&nbsp;LinkedIn</span></a>
                </div>
                <div id="post-toolbar-scroll-buttons">
                    <button id="post-toolbar-button-back-to-top" class="post-toolbar-button"><i class="fas fa-arrow-up fa-fw"></i><span class="post-toolbar-button-label">&nbsp;Back to top</span></button>
                    <a class="post-toolbar-button" href="#comments"><i class="fas fa-comments fa-fw"></i><span class="post-toolbar-button-label">&nbsp;Comments</span></a>
                </div>
            </div>
        </div>
    </div>
    <div id="post-body">
        <div id="post-body-inner">
            <nav id="post-toc">
                <div id="post-toc-title">Contents</div>
                <div id="post-toc-items"><ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#background">Background</a></li>
<li class="toc-entry toc-h1"><a href="#actor-model">Actor Model</a>
<ul>
<li class="toc-entry toc-h2"><a href="#actor-hierarchy">Actor Hierarchy</a></li>
<li class="toc-entry toc-h2"><a href="#actor-references">Actor References</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#akkanet">Akka.NET</a>
<ul>
<li class="toc-entry toc-h2"><a href="#actor-system">Actor System</a></li>
<li class="toc-entry toc-h2"><a href="#instantiating-actors">Instantiating Actors</a></li>
<li class="toc-entry toc-h2"><a href="#sending-messages-to-actors">Sending Messages to Actors</a></li>
<li class="toc-entry toc-h2"><a href="#writing-your-own-actors">Writing your own Actors</a></li>
<li class="toc-entry toc-h2"><a href="#creating-child-actors">Creating Child Actors</a></li>
<li class="toc-entry toc-h2"><a href="#sending-messages-to-the-parent-actor">Sending Messages to the Parent Actor</a></li>
<li class="toc-entry toc-h2"><a href="#sending-messages-to-the-current-actor">Sending Messages to the Current Actor</a></li>
<li class="toc-entry toc-h2"><a href="#replying-to-messages">Replying to Messages</a></li>
<li class="toc-entry toc-h2"><a href="#receiving-replied-messages">Receiving Replied Messages</a></li>
<li class="toc-entry toc-h2"><a href="#behaviours">Behaviours</a></li>
<li class="toc-entry toc-h2"><a href="#stashing-messages">Stashing Messages</a></li>
<li class="toc-entry toc-h2"><a href="#using-async-functions-in-akka">Using Async Functions in Akka</a></li>
<li class="toc-entry toc-h2"><a href="#bells--whistles">Bells & Whistles</a></li>
<li class="toc-entry toc-h2"><a href="#documentation">Documentation</a></li>
</ul>
</li>
</ul></div>
            </nav>
            <div id="post-content" itemprop="articleBody">
                <h1 id="background">Background</h1>
<p>Akka is an actor framework. We’ll cover what that means <a href="#actor-model">in the next section</a>. <a target="_BLANK" href="http://getakka.net/">Akka.NET</a> is a .NET port of the Scala <a target="_BLANK" href="http://akka.io/">Akka</a> framework. Akka.NET is an open source project that is actively maintained by the community. <a target="_BLANK" href="https://petabridge.com/">Petabridge</a> is one of the main contributors. This guide starts off by describing the actor model, and then goes onto to give some examples of how Akka.NET implements the actor model.</p>

<p>This guide only covers the basics of the actor model and Akka.NET. Basic knowledge of C# is assumed.</p>

<h1 id="actor-model">Actor Model</h1>
<p>The actor model is a way of structuring an application. Instead of classes calling each other directly, they communicate via <strong>messages</strong> via a framework. Classes that communicate in this manner are called <strong>Actors</strong>. A common analogy is that your application is a factory, your actors are your staff and messages are jobs that need doing.</p>

<table>
  <thead>
    <tr>
      <th>Things you can do with actors</th>
      <th>How this relates to traditional C#</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Actors talk to each other by sending messages to each other.</td>
      <td>Think of an actor as a function and the message as its parameters. When an actor sends a message to another actor, think of this as one function calling another.</td>
    </tr>
    <tr>
      <td>An actor can also send its self a message.</td>
      <td>Think of this as a function calling itself recursively.</td>
    </tr>
  </tbody>
</table>

<p>Actors only ever process one message at a time. They have a message inbox/queue that they store messages in until they are ready to process their next message. Actors can only talk to other actors via the sending of messages. When processing a message an actor can modify its own internal private state, but not the state of other actors.</p>

<p>The creation of actors and the sending of messages is done via a framework. There are lots of actor model frameworks, Akka is just one of them.</p>

<p>The actor model gives the following benefits:</p>

<ul>
  <li>Actors are <strong>thread safe</strong>. Due to only processing one message at a time)</li>
  <li>Actors are <strong>asynchronous</strong>. Sending a message to another actor does not block the thread.</li>
  <li>Actors live in a hierarchy which is great for <strong>error handling</strong>. We’ll cover that <a href="#actor-hierarchy">in the next section</a>.</li>
  <li>The actor model promotes <strong>scalable</strong> and more loosely coupled systems. Since actors only communicate via messages it is easy to spin up lots of actors to do more work as and when they’re needed.</li>
</ul>

<h2 id="actor-hierarchy">Actor Hierarchy</h2>
<p>One of the best features of the actor model is the actor hierarchy. An actor can create other actors. All actors like within the <em>Actor System</em>. When an actor creates another actor the newly created actor is the <em>child</em> actor and the actor that created it is the <em>parent</em> actor. This results in the application having a tree-like structure as follows:</p>

<p><img src="http://connelhooley.uk/assets/images/actor-hierarchy.png" alt="Actor hierarchy" /></p>

<p>When an actor throws an unhandled exception the parent actor must decide what to do. It has three options:</p>
<ul>
  <li>Restart all its child actors</li>
  <li>Just restart the failing child actor</li>
  <li>Escalate the error to its parent actor, who in turn has to the same three options.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Things you can do with actors</th>
      <th>How this relates to traditional C#</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Actors restart their child actors when an unhandled exception occurs</td>
      <td>This is used instead of traditional try-catch blocks.</td>
    </tr>
  </tbody>
</table>

<p>Actors should always delegate “dangerous” work it child actors.</p>

<h2 id="actor-references">Actor References</h2>
<p>You never instantiate an actor directly, you only ever hold a reference to it.</p>

<p><img src="http://connelhooley.uk/assets/images/actor-ref.png" alt="Actor ref" /></p>

<p>All actor references are the same regardless of which actor it points to. You can send an actor reference a message and the framework then ensures it reaches the correct actor’s queue/inbox. This ensures that:</p>

<ul>
  <li>You cannot access or modify the internal state of that actor.</li>
  <li>The only way to interact with that actor is to send it a message.</li>
</ul>

<p>These are two of the most important rules of the actor model and actor references ensure that these rules are always followed.</p>

<p>Actor references are also updated when an actor fails. If a parent restarts an actor the actor reference is still valid and the framework simply sends messages to the new restarted instance.</p>

<p><img src="http://connelhooley.uk/assets/images/actor-ref-new.png" alt="Actor ref new instance" /></p>

<h1 id="akkanet">Akka.NET</h1>
<p>Now it’s time to see how Akka.NET allows us to use the actor model in C#.</p>

<h2 id="actor-system">Actor System</h2>
<p>If actors are created by other actors how do you create your first actor? Akka.NET has an object called the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/B0425D96.htm">ActorSystem</a>. The system is an object you only create once per application. It is your entry point into Akka. The system can create actors. Since these actors do not have a parent actor they are referred to as <em>root</em> actors.</p>

<p>When creating a system, you must give it a name. It is possible to have actors on two different systems talk to each other over a network. The name is then used for routing purposes. Until you require such functionality don’t worry about what name you give to your system.</p>

<p>Below is an example of a console application that starts an actor system and then shuts it down when <code class="highlighter-rouge">CTRL + C</code> is pressed. You will need install the Akka NuGet package. Run the following command in the Package Manager Console <code class="highlighter-rouge">Install-Package Akka</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">ActorSystem</span> <span class="n">_system</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_system</span> <span class="p">=</span> <span class="n">ActorSystem</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"example-name"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">CancelKeyPress</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">eventArgs</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">eventArgs</span><span class="p">.</span><span class="n">Cancel</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// Cancelling the event prevents the process terminating too early</span>
                <span class="n">_system</span><span class="p">.</span><span class="nf">Terminate</span><span class="p">();</span>
            <span class="p">};</span>
            <span class="n">_system</span><span class="p">.</span><span class="n">WhenTerminated</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice we don’t use the system’s constructor. This is a running theme throughout the Akka framework. Most Akka classes have a “Create” instantiation method.</p>

<p>If you run this code you will see a warning stating the “NewtonSoftJsonSerializer has been detected as a default serializer”. This warning is nothing to worry about.</p>

<h2 id="instantiating-actors">Instantiating Actors</h2>
<p>Instantiating an actor in Akka can be done in one of two places:</p>
<ul>
  <li>In the ActorSystem (for creating <em>root</em> actors)</li>
  <li>Inside Actors (for creating <em>child</em> actors)</li>
</ul>

<p>To create an actor you need to use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/C622B6E1.htm">ActorOf</a> method. This method is available in both the ActorSystem and inside actors themselves. The ActorOf method takes a <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/CA4B795B.htm">Props</a> object and a name for the actor.</p>

<p>The actor name is used for routing as mentioned <a href="#actor-system">previously</a>. Unlike the ActorSystem however, the name is optional for Actors. If you do not provide one, Akka will assign it a GUID as a name at runtime. It is recommended to give your actors a meaningful and descriptive name. It is also worth mentioning that an actor cannot have two children with the same name.</p>

<p>The Props object takes a C# expression in its create method. Akka uses this expression when it starts an Actor. It also uses to it to create new instances when restarting failed actors, hence why it takes an expression and not just an instance of the actor you’re instantiating.</p>

<table>
  <thead>
    <tr>
      <th>Things you can do with actors</th>
      <th>How this relates to traditional C#</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Actors create other actors by creating Prop objects</td>
      <td>This used instead of classes “newing” up other classes.</td>
    </tr>
  </tbody>
</table>

<p>The below example instantiates a root actor of a type we haven’t created yet called “ExampleRootActor”.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">ActorSystem</span> <span class="n">_system</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_system</span> <span class="p">=</span> <span class="n">ActorSystem</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"example-name"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">CancelKeyPress</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">eventArgs</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">eventArgs</span><span class="p">.</span><span class="n">Cancel</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="n">_system</span><span class="p">.</span><span class="nf">Terminate</span><span class="p">();</span>
            <span class="p">};</span>

            <span class="c1">//Create root actor</span>
            <span class="n">IActorRef</span> <span class="n">rootActor</span> <span class="p">=</span> <span class="n">_system</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ExampleRootActor</span><span class="p">()),</span> <span class="s">"example-root-actor-name"</span><span class="p">);</span>

            <span class="n">_system</span><span class="p">.</span><span class="n">WhenTerminated</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note how the result of the ActorOf method is not the actor type we created. It is an <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/56C46846.htm">IActorRef</a>. As discussed previously the actor reference hides any of the ExampleRootActor’s internal state (regardless of whether it is public or private) and the only way to interact with the newly created root actor is to send it messages.</p>

<h2 id="sending-messages-to-actors">Sending Messages to Actors</h2>
<p>Firstly we need to create a message object. Messages are:</p>
<ul>
  <li>Simple <a target="_BLANK" href="https://en.wikipedia.org/wiki/Plain_old_CLR_object">POCO</a> classes</li>
  <li>Immutable</li>
  <li>Serialisable</li>
  <li>Small (if you need to send a very large object between two actors, send a unique identifier such as the object’s database ID instead of the large object itself)</li>
</ul>

<p>Below is an example of a simple message called “ExampleMessage”.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessage</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using constructor injection with public getters is the standard way of creating an immutable message.</p>

<p>Now we can use our actor ref to send the message to our root actor. We do this using the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/D0008D9.htm">tell</a> method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="n">IActorRef</span> <span class="n">rootActor</span> <span class="p">=</span> <span class="n">_system</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ExampleRootActor</span><span class="p">()),</span> <span class="s">"example-root-actor-name"</span><span class="p">);</span>

<span class="c1">// Send message to root actor via actor ref</span>
<span class="n">rootActor</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="s">"Example message information"</span><span class="p">));</span>

<span class="p">...</span>
</code></pre></div></div>

<p>The Tell method is “fire and forget”. It does not block the thread or wait for a response.</p>

<h2 id="writing-your-own-actors">Writing your own Actors</h2>
<p>To create your own actor you need to create a C# class and inherit from one of the Akka <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/DD956C95.htm">actor base</a> classes. The <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/B124B2AF.htm">ReceiveActor</a> class is the best general purpose base actor that should fulfil your needs the majority of the time.</p>

<p>There are extensions to the Akka framework whereby you must inherit from different base classes when you want to use them. For example if you want your actors to persist their state in a database, you can use the <a target="_BLANK" href="http://getakka.net/docs/persistence/persistent-actors">Akka.Persistence</a> extension. To use this extension, you must inherit from the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/B124B2AF.htm">PersistentActor</a> base class in the actors where you want such functionality. This guide will only focus on creating standard actors with the before mentioned ReceiveActor base class.</p>

<p>When creating a receive actor you must configure the actor inside its constructor by telling it what function to call when it receives a certain type of object as a message. Below is an example.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleRootActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleRootActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Run the following lambda when a message of the type ExampleMessage is sent to this actor </span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessage</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">public</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/5C8C7532.htm">Receive</a> method inherited from the ReceiveActor base class to assign a lambda that is to be ran whenever a message of a particular type is received by the actor. For the remainder of this guide we will refer to these lambdas as <em>receive callbacks</em>. Unfortunately, you cannot use C# method groups in the Receive method call due to some of the overloads on the Receive method.</p>

<p>Actors simply ignore messages that they do not have a receive callback registered for.</p>

<p>If a class matches the type of two receive callbacks (e.g. if there are two receive callbacks for the same type or for if a type matches two callbacks through inheritance) then only the callback that is registered first is called.</p>

<h2 id="creating-child-actors">Creating Child Actors</h2>
<p>To create a child actor from inside an actor you use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/CD4308E5.htm">Actor Context</a> object. When an actor is created inside the actor system, Akka initialises certain properties on the actor. This is another reason why we create Props objects to create actors rather than just newing them up. The context is one of those properties that is populated for us by the framework.</p>

<p>The Context exposes the same ActorOf method we saw in the ActorSystem <a href="#instantiating-actors">previously</a>. Below is an example of creating a child actor we haven’t written yet called “ExampleChildActor” and then sending it a message.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleRootActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IActorRef</span> <span class="n">_exampleActorRef</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ExampleRootActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Create child actor</span>
            <span class="n">_exampleActorRef</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ExampleChildActor</span><span class="p">()),</span> <span class="s">"example-child-actor"</span><span class="p">);</span>
            <span class="c1">// send child actor a message</span>
            <span class="n">_exampleActorRef</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="s">"Example message information"</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="sending-messages-to-the-parent-actor">Sending Messages to the Parent Actor</h2>
<p>You can use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/88D6E91E.htm">Parent</a> property on an actor’s context object to obtain an actor ref to its parent (the actor that created it). You can then use this to send messages to the parent actor. Below is an example where we send a message called “ExampleSuccessMessage” to the actor’s parent.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleChildActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleChildActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">// Process message</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">exampleMessage</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">);</span>

                <span class="c1">// Send a new message to parent actor</span>
                <span class="n">Context</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">ExampleSuccessMessage</span><span class="p">());</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleSuccessMessage</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="sending-messages-to-the-current-actor">Sending Messages to the Current Actor</h2>
<p>Just as you can send messages to the parent, you can also send messages to the current actor that is processing the message. This is called sending messages to <em>Self</em>. Below is an example where we send a message of the type “ExampleSelfMessage” to the current actor when we receive a message of the type “ExampleMessage”.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleSelfTellActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleSelfTellActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="nf">ReceiveExampleMessage</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleSelfMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="nf">ReceiveExampleSelfMessage</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">ReceiveExampleMessage</span><span class="p">(</span><span class="n">ExampleMessage</span> <span class="n">exampleMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Process message</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">exampleMessage</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">);</span>
            
            <span class="c1">// Send a new message to self</span>
            <span class="n">Self</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">ExampleSelfMessage</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">ReceiveExampleSelfMessage</span><span class="p">(</span><span class="n">ExampleSelfMessage</span> <span class="n">exampleSelfMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// TODO Process message sent to self here</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessage</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">ExampleSelfMessage</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One of the more common reasons for doing this is that doing so uses the actor’s message queue/inbox. When you send a message to yourself the message is put at the back of the message queue meaning the actor can get through some of the other messages in the queue before dealing with the message you just sent to yourself. Actors do not differentiate between messages sent from other actors or themselves.</p>

<p>I tend to nest message classes inside the actor class that predominantly uses them. This makes it clear where the message is used most. This also allows you to make the message class private when the message type is only sent to and from the actor itself, therefore preventing it from being used in other actors. If a message is used by multiple actors then I place them in their own namespace.</p>

<h2 id="replying-to-messages">Replying to Messages</h2>
<p>Just as you can send messages to the parent actor and yourself, you can also send messages to the actor that sent you the message you’re currently processing. This is called <em>replying</em> to a message. In the example below we send a message of the type “ExampleReplyMessage” back to any actors that send us a message of the type “ExampleMessage”.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleReplyActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleReplyActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">// Process message</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">exampleMessage</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">);</span>

                <span class="c1">// Send a new message to the actor that the sent current message to this actor</span>
                <span class="n">Context</span><span class="p">.</span><span class="n">Sender</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">ExampleReplyMessage</span><span class="p">());</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessage</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ExampleMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleReplyMessage</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="receiving-replied-messages">Receiving Replied Messages</h2>
<p>If when sending a message to an actor, you expect a reply back, you can use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/88D6E91E.htm">Ask</a> method. This simply returns a C# Task that resolves when the target actor replies with a message of the desired type. It essentially allows you to request a message from the target actor and await a response, a bit like a HTTP request/response. In the example below we:</p>
<ul>
  <li>Create a child actor in the constructor</li>
  <li>Set up a receive callback that:
    <ul>
      <li>Sends the child actor an ExampleRequestMessage</li>
      <li>Blocks the thread until the child actor replies with an ExampleResponseMessage</li>
    </ul>
  </li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleAskActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IActorRef</span> <span class="n">_exampleReplyActorRef</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ExampleAskActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ReceiveAsync</span><span class="p">&lt;</span><span class="n">Start</span><span class="p">&gt;(</span><span class="n">ReceiveStartAsync</span><span class="p">);</span>
            <span class="n">_exampleReplyActorRef</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ExampleReplyActor</span><span class="p">()),</span> <span class="s">"example-reply-actor-name"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ReceiveStartAsync</span><span class="p">(</span><span class="n">Start</span> <span class="n">start</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ExampleReplyActor</span><span class="p">.</span><span class="n">ExampleResponseMessage</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_exampleReplyActorRef</span><span class="p">.</span><span class="n">Ask</span><span class="p">&lt;</span><span class="n">ExampleReplyActor</span><span class="p">.</span><span class="n">ExampleResponseMessage</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">ExampleReplyActor</span><span class="p">.</span><span class="nf">ExampleRequestMessage</span><span class="p">(</span><span class="s">"Hello, World"</span><span class="p">));</span>

            <span class="c1">// The following will print "Successfully replying to message: Hello, World"</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">Start</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that it is possible to use async receive callbacks using the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/6A92E9E6.htm">ReceiveAsync</a> method. This is required to await the Task returned from the Ask method. Due to having different overloads compared to the synchronous Receive method, you can use method groups with the ReceiveAsync method.</p>

<p>Also note that you don’t have to use the Ask method to receive messages that are a reply. You can also treat them just like any other message and simply receive them as normal, as described <a href="#writing-your-own-akka-actors">previously</a>.</p>

<h2 id="behaviours">Behaviours</h2>
<p>An actor can reallocate its receive callbacks at run time. When an actor changes the callbacks it is currently using, it is said to be <em>switching behaviours</em>. To switch behaviours you use the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/2F03E8DE.htm">Become</a> method. Below is an example.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleBehaviourActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExampleBehaviourActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Become</span><span class="p">(</span><span class="n">Starting</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Starting</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessageType1</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">//TODO Do something with first message type that would make actor ready for second message type</span>
                <span class="nf">Become</span><span class="p">(</span><span class="n">Started</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Started</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessageType2</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">//TODO Do something with second message type</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessageType1</span> <span class="p">{</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessageType2</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above example has two states: Starting and Started. The actor becomes <em>Starting</em> when it is constructed. In this behaviour the actor only processes messages of the type “ExampleMessageType1”. When the actor receives a message of the type “ExampleMessageType1” it becomes <em>Started</em>. In this behaviour the actor only processes messages of the type “ExampleMessageType2”.</p>

<p>This results in an actor that :</p>

<ul>
  <li>Must receive a message of the type “ExampleMessageType1” before it will process messages of the type “ExampleMessageType2”.</li>
  <li>Will ignore all messages of type “ExampleMessageType1” apart from the first one it receives.</li>
</ul>

<p>It is important to note that receive callbacks from previous behaviours are not carried over to new behaviours.</p>

<h2 id="stashing-messages">Stashing Messages</h2>
<p>Stashing is often used in conjunction with <a href="#behaviours">behaviours</a>. It allows you to store messages temporarily in memory until you’re ready to process them. To implement stashing in your actor you must implement the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/B13D7126.htm">IWithUnboundedStash</a> interface. The interface itself simply contains a public property for an <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/83B3E7F5.htm">IStash</a> object. Akka then watches for actors that implement this interface when it creates them in the ActorOf method. If it sees an Actor that implements the interface it populates the IStash property for you.</p>

<p>To achieve <em>stashing</em> we use two methods on the Stash property:</p>
<ul>
  <li>The <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/5227A101.htm">Stash</a> method places the current message that is being processed in the Stash.</li>
  <li>The <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/804DA779.htm">UnstashAll</a> method places all the messages currently in the stash at the beginning of the actor’s message inbox/queue. Below is an example.</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleStashActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span><span class="p">,</span> <span class="n">IWithUnboundedStash</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">IStash</span> <span class="n">Stash</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// Property to implement IWithUnboundedStash</span>

        <span class="k">public</span> <span class="nf">ExampleStashActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Become</span><span class="p">(</span><span class="n">Starting</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Starting</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessageType1</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">//TODO Do something with first message type that would make actor ready for second message type</span>
                <span class="nf">Become</span><span class="p">(</span><span class="n">Started</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessageType2</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">Stash</span><span class="p">.</span><span class="nf">Stash</span><span class="p">());</span> <span class="c1">// Stash ExampleMessageType2 while starting</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Started</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleMessageType2</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="c1">//TODO: do something with second message type</span>
            <span class="p">});</span>
            <span class="n">Stash</span><span class="p">.</span><span class="nf">UnstashAll</span><span class="p">();</span> <span class="c1">// Unstash stashed messages when started</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessageType1</span> <span class="p">{</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleMessageType2</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above example results in an actor that stores all messages of the type “ExampleMessageType2” in its stash until it receives a message of the type “ExampleMessageType1” whereby it unstashes all of the previously stashed messages. The messages are then processed in the same order as to which they were sent. It is important to note that unstashed messages get put at the front of the queue. Petabridge explains this really well in their bootcamp <a target="_BLANK" href="https://github.com/petabridge/akka-bootcamp/blob/master/src/Unit-2/lesson5/README.md#unstashing-the-entire-stash-at-once">here</a>.</p>

<h2 id="using-async-functions-in-akka">Using Async Functions in Akka</h2>
<p>If you want to use a C# async function in your actor, but don’t want to block the thread like <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/6A92E9E6.htm">ReceiveAsync</a> does, then you can <em>pipe</em> a task’s result into a message that is sent to an actor.</p>

<p>This is done using the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/29094973.htm">PipeTo</a> method. PipeTo is an extension method on the Task object. This means you can use it on pretty much all async functions in C#. It allows you to send the result of a task to an actor.</p>

<p>This is the most common and recommended way of using async functions in Akka. In-fact, ReceiveAsync is a relatively new feature in Akka - and before that - piping was the only way to use async functions in Akka. Below is an example:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExamplePipeToActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ExamplePipeToActor</span><span class="p">(</span><span class="n">IThingyDoer</span> <span class="n">thingyDoer</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleRequestMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="n">thingyDoer</span>
                    <span class="p">.</span><span class="nf">DoAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span>
                        <span class="n">task</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ExampleResponseMessage</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">),</span> 
                        <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">ExecuteSynchronously</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">PipeTo</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ExampleResponseMessage</span><span class="p">&gt;(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">ExampleData</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleRequestMessage</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ExampleRequestMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">ExampleResponseMessage</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ExampleResponseMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">exampleData</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExampleData</span> <span class="p">=</span> <span class="n">exampleData</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="kt">string</span> <span class="n">ExampleData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the above example, we call an async function when we receive an ExampleRequestMessage. We use ContinueWith to map the task’s completed result to a message type. We then use the PipeTo function to <em>pipe</em> the message to ourselves. Doing this does not block the thread and simply places an immutable message in our inbox when the task completes.</p>

<p>One import thing to note is that the <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/CD4308E5.htm">context</a> property is only valid when an actor is processing a message. If you try and access the context in an async callback then an exception is thrown. This is because the async callbacks are ran later on and the actor could be in the middle of processing a different message by then. If you need to access the context in any of your async callbacks, close over them so you don’t need to use the context in your callbacks. There is a great blog post about async in Akka that covers this and more by Petabridge that you can find <a target="_BLANK" href="https://petabridge.com/blog/akkadotnet-async-actors-using-pipeto/">here</a>.</p>

<h2 id="bells--whistles">Bells &amp; Whistles</h2>
<p>Below is an example that covers everything we have covered so far (and one thing we haven’t) in one actor:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AkkaExamples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span><span class="p">,</span> <span class="n">IWithUnboundedStash</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">HttpClient</span> <span class="n">_client</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">DownloadActor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Become</span><span class="p">(</span><span class="n">Idle</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IStash</span> <span class="n">Stash</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">PreStart</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">PreStart</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">PostStop</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_client</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">PostStop</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Idle</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">Download</span><span class="p">&gt;(</span><span class="n">start</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">_client</span>
                    <span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">Url</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">PipeTo</span><span class="p">(</span>
                        <span class="n">Self</span><span class="p">,</span> 
                        <span class="n">Self</span><span class="p">,</span> 
                        <span class="n">httpRes</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">DownloadComplete</span><span class="p">(</span><span class="n">httpRes</span><span class="p">.</span><span class="n">Content</span><span class="p">),</span> 
                        <span class="n">exception</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">DownloadFailure</span><span class="p">());</span>
                <span class="nf">Become</span><span class="p">(</span><span class="n">Downloading</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Downloading</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ReceiveAsync</span><span class="p">&lt;</span><span class="n">DownloadComplete</span><span class="p">&gt;(</span><span class="k">async</span> <span class="n">download</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">content</span> <span class="p">=</span> <span class="k">await</span> <span class="n">download</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>
                <span class="n">Context</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadResult</span><span class="p">(</span><span class="n">content</span><span class="p">));</span>
                <span class="n">Stash</span><span class="p">.</span><span class="nf">UnstashAll</span><span class="p">();</span>
                <span class="nf">Become</span><span class="p">(</span><span class="n">Idle</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">DownloadFailure</span><span class="p">&gt;(</span><span class="n">failure</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">Context</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="n">failure</span><span class="p">);</span>
                <span class="n">Stash</span><span class="p">.</span><span class="nf">UnstashAll</span><span class="p">();</span>
                <span class="nf">Become</span><span class="p">(</span><span class="n">Idle</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="n">Receive</span><span class="p">&lt;</span><span class="n">Download</span><span class="p">&gt;(</span><span class="n">start</span> <span class="p">=&gt;</span> <span class="n">Stash</span><span class="p">.</span><span class="nf">Stash</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">Download</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">public</span> <span class="nf">Download</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Url</span> <span class="p">=</span> <span class="n">url</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">DownloadComplete</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="n">HttpContent</span> <span class="n">Content</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">public</span> <span class="nf">DownloadComplete</span><span class="p">(</span><span class="n">HttpContent</span> <span class="n">content</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Content</span> <span class="p">=</span> <span class="n">content</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadResult</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">Content</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">public</span> <span class="nf">DownloadResult</span><span class="p">(</span><span class="kt">string</span> <span class="n">content</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Content</span> <span class="p">=</span> <span class="n">content</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadFailure</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The thing we haven’t covered yet is <em>actor life cycle hooks</em>. This example uses them to create and dispose of a HTTP client when the actor is started and stopped. You can find out more about the actor life cycle in Akka <a target="_BLANK" href="http://getakka.net/docs/Actor%20lifecycle">here</a>.</p>

<p>The above example:</p>
<ul>
  <li>Stashes requests to download something when it is already in the middle of downloading something. It then goes back to the stashed messages when it is finished.</li>
  <li>Pipes the result of DownloadAsync to itself so the thread isn’t blocked while it downloads.</li>
  <li>Uses ReceiveAsync and awaits ReadAsStringAsync rather than using piping. This keeps the code cleaner and piping messages around for something that should not take long can be overkill.</li>
  <li>Sends the parent actor a message when the download has succeeded or failed.</li>
  <li>Uses the overloaded version of <a target="_BLANK" href="http://api.getakka.net/docs/stable/html/6BE66425.htm">PipeTo</a> that returns a different message when the task fails to complete.</li>
</ul>

<h2 id="documentation">Documentation</h2>
<p>The main sources of documentation and information for Akka.NET are:</p>
<ul>
  <li><a target="_BLANK" href="http://getakka.net/docs/">The official docs</a></li>
  <li><a target="_BLANK" href="http://api.getakka.net/docs/stable/html/5590F8C9.htm">The official API reference</a></li>
  <li><a target="_BLANK" href="https://petabridge.com/blog/">Petabridge blog</a></li>
</ul>

<p>When searching for Akka information online, ensure you always add “net” onto your searches otherwise you’ll most probably get results that refer to the Scala version.</p>


            </div>
            <div id="comments">
                
                    
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
    this.page.url = 'http://connelhooley.uk/blog/2017/02/21/akka-guide';
    this.page.identifier = 'http://connelhooley.uk/blog/2017/02/21/akka-guide';
};

(function() {
    var d = document, s = d.createElement('script');

    s.src = 'https://connelhooley.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


                
            </div>
        </div>
    </div>
</article>
</main>    
    <footer id="site-footer" class="site-footer-post">
        <div id="site-footer-inner">
            <div id="site-footer-copy">
                Connel Hooley <i class="far fa-copyright"></i> 2018
            </div>
            
            <div id="site-footer-contact">
                <a href="mailto:me@connelhooley.uk" target="_BLANK"><i class="fas fa-envelope fa-fw"></i>&nbsp;Email</a>&nbsp;&bull;
                <a href="https://twitter.com/connel_dev" target="_BLANK"><i class="fab fa-twitter fa-fw"></i>&nbsp;Twitter</a>&nbsp;&bull;
                <a href="http://uk.linkedin.com/in/connelhooley" target="_BLANK"><i class="fab fa-linkedin fa-fw"></i>&nbsp;LinkedIn</a>&nbsp;&bull;
                <a href="/feed.xml" target="_BLANK"><i class="fas fa-rss"></i>&nbsp;Blog RSS</a>
            </div>
            
        </div>
    </footer>
    
    <script src="/assets/js/vendor/jquery-3.1.1.min.js"></script>
    <script src="/assets/js/vendor/moment.min.js"></script>
    <script src="/assets/js/vendor/clipboard.min.js"></script>
    <script src="/assets/js/vendor/js.cookie.js"></script>
    <script src="/assets/js/vendor/stickyfill.min.js"></script>
    
    <script src="/assets/js/vendor/fixanchorlinks.js"></script>
    
    <script src="/assets/js/main.js"></script>
    
</body>