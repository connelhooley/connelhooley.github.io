<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connel Hooley - Introducing Akka Testing Helpers</title>
  
  <link rel="stylesheet" href="/assets/css/main.css">
  

  <link rel="alternate" type="application/rss+xml" title="Connel Hooley" href="/feed.xml">  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#f8bb15">
  <meta name="theme-color" content="#f8bb15">
  
  
  <!-- Begin Jekyll SEO tag v2.1.0 -->
<meta property="og:title" content="Introducing Akka Testing Helpers" />
<meta name="description" content="Introduction to my new Akka DI testing NuGet package." />
<meta property="og:description" content="Introduction to my new Akka DI testing NuGet package." />
<link rel="canonical" href="http://connelhooley.uk/blog/2017/09/30/introducing-akka-testing-helpers-di" />
<meta property="og:url" content="http://connelhooley.uk/blog/2017/09/30/introducing-akka-testing-helpers-di" />
<meta property="og:site_name" content="Connel Hooley" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-30T19:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@connel_dev" />
<meta name="twitter:creator" content="@connel_dev" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Introducing Akka Testing Helpers",
"datePublished": "2017-09-30T19:00:00+01:00",
"description": "Introduction to my new Akka DI testing NuGet package.",
"publisher": {"@type": "Organization",
"logo": {"@type": "ImageObject",
"url": "http://connelhooley.uk/assets/images/logo.png"}},
"url": "http://connelhooley.uk/blog/2017/09/30/introducing-akka-testing-helpers-di"}</script>
<!-- End Jekyll SEO tag -->

  
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57397582-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

  <body class="layout-post">
    <header class="site-header" role="banner">
  <div class="site-header-content">
    <div class="site-nav-wrapper">
      <nav class="site-nav navbar navbar-toggleable-md" role="navigation">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#collapseNavbar" aria-controls="collapseNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <i class="fa fa-bars" aria-hidden="true"></i>
        </button>
        
        <a class="navbar-brand" href="/"><span class="logo">{C.H}</span></a>
        
        <div class="collapse navbar-collapse" id="collapseNavbar">
          <div class="nav navbar-nav ml-auto">
            <a id="blog-link" class="nav-item nav-link" href="/blog/">Blog</a>
            
            
              
                
                
                
                  <a id="projects-link" class="nav-item nav-link" href="/projects/">Projects</a>
                
              
            
              
                
                
                
                  <a id="experiences-link" class="nav-item nav-link" href="/experience/">Experience</a>
                
              
            
          </div>
        </div>
      </nav>
    </div>
  </div>
</header>

    <main class="site-content" aria-label="Content">
      <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="header">
    <div class="header-content">
        <h1 class="title" itemprop="name headline">Introducing Akka Testing Helpers</h1>
        
            <div class="content description">
                Introduction to my new Akka DI testing NuGet package.
            </div>
        
        
        
            <div class="content">
                <time datetime="2017-09-30T19:00:00+01:00" itemprop="datePublished">
                    <date class="date" datetime="2017-09-30 19:00:00 +0100"><i class="fa fa-calendar" aria-hidden="true"></i>&nbsp;30/09/2017</date>
                </time>
            </div>
            <div class="content">
                <i class="fa fa-clock-o" aria-hidden="true"></i>&nbsp;Read in under 13  minutes
            </div>
        
        
        
            <div class="content">
                
<a href="/language/c-sharp"><span class="tag"><i class="fa fa-code" aria-hidden="true"></i>&nbsp;C#</span></a>


<a href="/technology/akka-dot-net"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Akka.NET</span></a>

            </div>
        
        
    </div>
</header>
  


<div class="post-toolbar sticky">
    <div class="post-toolbar-contents">
        <div class="share-buttons">
            <span class="label"><i class="fa fa-share-alt fa-fw" aria-hidden="true"></i>&nbsp;Share&nbsp;</span>
            <a class="toolbar-button" target="_BLANK" href="https://twitter.com/intent/tweet?text=Introducing+Akka+Testing+Helpers+by+%40connel_dev&url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F09%2F30%2Fintroducing-akka-testing-helpers-di"><i class="fa fa-twitter-square fa-fw" aria-hidden="true"></i><span class="button-label">&nbsp;Tweet</span></a>
            <a class="toolbar-button" target="_BLANK" href="//www.reddit.com/submit?url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F09%2F30%2Fintroducing-akka-testing-helpers-di&title=Introducing+Akka+Testing+Helpers"><i class="fa fa-reddit-square fa-fw" aria-hidden="true"></i><span class="button-label">&nbsp;Reddit</span></a>
            <a class="toolbar-button" target="_BLANK" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fconnelhooley.uk%2Fblog%2F2017%2F09%2F30%2Fintroducing-akka-testing-helpers-di&title=Introducing+Akka+Testing+Helpers"><i class="fa fa-linkedin-square fa-fw" aria-hidden="true"></i><span class="button-label">&nbsp;LinkedIn</span></a>
        </div>
        <div class="scroll-buttons">
            <button id="back-to-top" class="toolbar-button"><i class="fa fa-arrow-up fa-fw" aria-hidden="true"></i><span class="button-label">&nbsp;Back to top</span></button>
            <a class="toolbar-button" href="#comments"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span class="button-label">&nbsp;Comments</span></a>
        </div>
    </div>
</div>
  
  <div class="post-body">
    <nav class="post-toc">
      <div class="toc-title">Contents</div>
      <div class="toc-items"><ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#the-problem">The problem</a></li>
<li class="toc-entry toc-h1"><a href="#about-the-solution">About the solution</a></li>
<li class="toc-entry toc-h1"><a href="#the-solution">The solution</a></li>
<li class="toc-entry toc-h1"><a href="#get-it-on-nuget">Get it on NuGet</a></li>
<li class="toc-entry toc-h1"><a href="#whats-next">What’s next</a></li>
</ul></div>
    </nav>
    <div class="post-content" itemprop="articleBody">
      <h1 id="introduction">Introduction</h1>
<p>Myself and my colleagues found actors inside a hierarchy difficult to unit test when we began working on our first Akka production code base. I would like to first discuss why we found it difficult before presenting my solution.</p>

<h1 id="the-problem">The problem</h1>
<p>When unit testing, we wanted to mock out all children and parent actors, and for integration tests we wanted to mock out only some of the children and parents.</p>

<p>This <a target="_BLANK" href="https://petabridge.com/blog/how-to-unit-test-akkadotnet-actors-akka-testkit/#how-do-i-test-a-parentchild-relationship">Petabridge blog post</a> describes how to unit test a parent-child relationship with the following example:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ChildActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ChildActor</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReceiveAny</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">Sender</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="s">"hello!"</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ParentActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ParentActor</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">child</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ChildActor</span><span class="p">()));</span>
        <span class="nf">ReceiveAny</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">child</span><span class="p">.</span><span class="nf">Forward</span><span class="p">(</span><span class="n">o</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="na">[TestFixture]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ParentGreeterSpecs</span> <span class="p">:</span> <span class="n">TestKit</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Parent_should_create_child</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// verify child has been created by sending parent a message
</span>        <span class="c1">// that is forwarded to child, and which child replies to sender with
</span>        <span class="kt">var</span> <span class="n">parentProps</span> <span class="p">=</span> <span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ParentActor</span><span class="p">());</span>
        <span class="kt">var</span> <span class="n">parent</span> <span class="p">=</span> <span class="n">ActorOfAsTestActorRef</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;(</span><span class="n">parentProps</span><span class="p">,</span> <span class="n">TestActor</span><span class="p">);</span>
        <span class="n">parent</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="s">"this should be forwarded to the child"</span><span class="p">);</span>
        <span class="nf">ExpectMsg</span><span class="p">(</span><span class="s">"hello!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Although this example seems fine, if the <code class="highlighter-rouge">ChildActor</code> had its own children, then this test could potentially run code in those children and every single actor underneath them. Take the following actor hierarchy (where actor <code class="highlighter-rouge">C</code> has an interface injected into it rather than having its own children):</p>

<p><img src="http://connelhooley.uk/assets/images/introducing-akka-testing-helpers-di/actor-hierarchy.png" alt="Actor hierarchy" /></p>

<p>Using the Petabridge method to test actor <code class="highlighter-rouge">D</code>, the actors being tested look like this:</p>

<p><img src="http://connelhooley.uk/assets/images/introducing-akka-testing-helpers-di/actor-hierarchy-testing-d.png" alt="Actor hierarchy highlighted where testing actor D" /></p>

<p>It would be much better to mock out the children and just test actor <code class="highlighter-rouge">D</code> like this:</p>

<p><img src="http://connelhooley.uk/assets/images/introducing-akka-testing-helpers-di/actor-hierarchy-testing-d-mocks.png" alt="Actor hierarchy highlighted where testing actor D with mocks" /></p>

<p>The Petabridge blog post also describes <img target="_BLANK" src="https://petabridge.com/blog/how-to-unit-test-akkadotnet-actors-akka-testkit/#example" alt="how to replace your actors with mock versions, such as the `BlackHoleActor`" /> using the following example:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">public</span> <span class="nf">IdentityManagerActor</span><span class="p">(</span><span class="n">IActorRef</span> <span class="n">authenticationActor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_authenticator</span> <span class="p">=</span> <span class="n">authenticationActor</span><span class="p">;</span>

    <span class="n">Receive</span><span class="p">&lt;</span><span class="n">CreateUser</span><span class="p">&gt;(</span><span class="n">create</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">senderClosure</span> <span class="p">=</span> <span class="n">Sender</span><span class="p">;</span>

        <span class="c1">// this actor needs it create user request to be authenticated
</span>        <span class="c1">// within 2 seconds or this operation times out &amp; cancels
</span>        <span class="c1">// the Task returned by Ask&lt;&gt;
</span>        <span class="n">_authenticator</span><span class="p">.</span><span class="n">Ask</span><span class="p">&lt;</span><span class="n">UserResult</span><span class="p">&gt;(</span><span class="n">create</span><span class="p">,</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">tr</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">.</span><span class="n">IsCanceled</span> <span class="p">||</span> <span class="n">tr</span><span class="p">.</span><span class="n">IsFaulted</span><span class="p">)</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">UserResult</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">tr</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
            <span class="p">}).</span><span class="nf">PipeTo</span><span class="p">(</span><span class="n">senderClosure</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// other code omitted for brevity...
</span>
<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">IdentityManagerActor_should_fail_create_user_on_timeout</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// the BlackHoleActor will NEVER respond to any message sent to it
</span>    <span class="c1">// which will force the CreateUser request to time out
</span>    <span class="kt">var</span> <span class="n">blackhole</span> <span class="p">=</span> <span class="n">Sys</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">BlackHoleActor</span><span class="p">.</span><span class="n">Props</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">identity</span> <span class="p">=</span> <span class="n">Sys</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">IdentityManagerActor</span><span class="p">(</span><span class="n">blackhole</span><span class="p">)));</span>

    <span class="n">identity</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="nf">CreateUser</span><span class="p">());</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">ExpectMsg</span><span class="p">&lt;</span><span class="n">UserResult</span><span class="p">&gt;().</span><span class="n">Successful</span><span class="p">;</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">False</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Although again this example seems fine, it results in losing the actor hierarchy. If you create two root actors from your <code class="highlighter-rouge">ActorSystem</code> and then inject one into another, then the actors are siblings rather than parent and child.</p>

<h1 id="about-the-solution">About the solution</h1>
<p>If you want to maintain the actor hierarchy then you must create children inside the parent. This is where DI comes to the rescue. Akka makes it easy to modify how child actors are resolved. This is done by implementing an interface called <code class="highlighter-rouge">DependencyResolver</code>. The interface takes in the <code class="highlighter-rouge">Type</code> of actor you want to create, and then performs some logic to create it. Dependency resolvers don’t have to create the actor type that is requested, they can return any actor type. This makes it possible to create a simple dependency resolver that always returns mock actors regardless of the type is asked for.</p>

<p>The <code class="highlighter-rouge">TestProbe</code> is a great testing class in Akka that you can use as a mock actor. They allow you to assert if they have received a certain message. You can also modify their behaviour using an object called <code class="highlighter-rouge">AutoPilot</code>. This makes it a perfect class to return from a <code class="highlighter-rouge">DependencyResolver</code>.</p>

<p>Child actors are created asynchronously. This means that when running a test to assert that an actor has created a child, then it is very possible that your assertion could be ran before the child is created. This kind of async issue can crop up when running unit tests on slow build servers. Akka has a class called <code class="highlighter-rouge">TestLatch</code> that allows you to block a thread until an event has happened a certain amount of times. This makes it a perfect mechanism for waiting until the required number of children have been resolved.</p>

<h1 id="the-solution">The solution</h1>
<p>My unit testing solution is a custom <code class="highlighter-rouge">DependencyResolver</code> that replaces all resolved children with <code class="highlighter-rouge">TestProbe</code> instances and that uses a <code class="highlighter-rouge">TestLatch</code> to ensure that the children have been created before running any assertions.</p>

<p>My NuGet package wraps all this up in a way that is super easy to consume. The resolver keeps track of all the test probes so you can access them once your SUT (System Under Test) has been created.</p>

<p>Below is an example test class that checks if an actor creates the correct type, and gives it the correct name:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.DI.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit.Xunit2</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FluentAssertions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConnelHooley.AkkaTestingHelpers.DI.MediumTests.TestProbeResolverTests.Examples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Examples1</span> <span class="p">:</span> <span class="n">TestKit</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">ChildActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span> <span class="p">{</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ParentActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ParentActor</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">child1</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="nf">DI</span><span class="p">().</span><span class="n">Props</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">&gt;(),</span> <span class="s">"child-actor-1"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">child2</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="nf">DI</span><span class="p">().</span><span class="n">Props</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">&gt;(),</span> <span class="s">"child-actor-2"</span><span class="p">);</span>
                <span class="n">child1</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="s">"hello actor 1"</span><span class="p">);</span>
                <span class="n">child2</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="m">42</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ParentActor_Constructor_CreatesChildWithCorrectTypeAndName</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//arrange
</span>            <span class="n">TestProbeResolver</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">TestProbeResolverSettings</span>
                <span class="p">.</span><span class="n">Empty</span>
                <span class="p">.</span><span class="nf">CreateResolver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            
            <span class="c1">//act
</span>            <span class="n">TestActorRef</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;</span> <span class="n">sut</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">CreateSut</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;(</span><span class="m">2</span><span class="p">);</span>
            
            <span class="c1">//assert
</span>            <span class="n">resolver</span>
                <span class="p">.</span><span class="nf">ResolvedType</span><span class="p">(</span><span class="n">sut</span><span class="p">,</span> <span class="s">"child-actor-1"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ParentActor_Constructor_SendsChildCorrectMessage</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//arrange
</span>            <span class="n">TestProbeResolver</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">TestProbeResolverSettings</span>
                <span class="p">.</span><span class="n">Empty</span>
                <span class="p">.</span><span class="nf">CreateResolver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

            <span class="c1">//act
</span>            <span class="n">TestActorRef</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;</span> <span class="n">sut</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">CreateSut</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;(</span><span class="m">2</span><span class="p">);</span>

            <span class="c1">//assert
</span>            <span class="n">resolver</span>
                <span class="p">.</span><span class="nf">ResolvedTestProbe</span><span class="p">(</span><span class="n">sut</span><span class="p">,</span> <span class="s">"child-actor-1"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">ExpectMsg</span><span class="p">(</span><span class="s">"hello actor 1"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s walk through this example:</p>
<ul>
  <li>Firstly, you create a settings object. The settings object contains the custom handlers for each of your children.
If you do not want your actor’s children to reply to any messages then create an empty settings object. Once you have a settings object you can construct the resolver from the settings object by passing in a <code class="highlighter-rouge">TestKit</code> instance.</li>
  <li>Then you can create an actor. If the actor has a parameterless constructor then you can simply enter the number of children you expect it to create. The resolver then waits for the specified number of children to be resolved before returning a <code class="highlighter-rouge">TestActorRef</code>.</li>
  <li>You can query the resolver for either of the following based on the child’s expected name:
    <ul>
      <li>The resolved <code class="highlighter-rouge">TestProbe</code>.</li>
      <li>The type of actor the parent asked for.</li>
    </ul>
  </li>
</ul>

<p>Below is an example that configures the child actor to reply to messages, and then asserts that a mock is given the replied message:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.DI.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit.Xunit2</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Moq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConnelHooley.AkkaTestingHelpers.DI.MediumTests.TestProbeResolverTests.Examples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Examples2</span> <span class="p">:</span> <span class="n">TestKit</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">ChildActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="k">class</span> <span class="nc">ModifiedSave</span>
            <span class="p">{</span>
                <span class="k">public</span> <span class="kt">string</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

                <span class="k">public</span> <span class="nf">ModifiedSave</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">interface</span> <span class="n">IRepository</span>
        <span class="p">{</span>
            <span class="k">void</span> <span class="nf">Save</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">ParentActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">ParentActor</span><span class="p">(</span><span class="n">IRepository</span> <span class="n">repo</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">child</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">ActorOf</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="nf">DI</span><span class="p">().</span><span class="n">Props</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">&gt;(),</span> <span class="s">"child-actor-1"</span><span class="p">);</span>
                <span class="n">Receive</span><span class="p">&lt;</span><span class="n">Save</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">child</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
                <span class="n">Receive</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">.</span><span class="n">ModifiedSave</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">repo</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="k">class</span> <span class="nc">Save</span>
            <span class="p">{</span>
                <span class="k">public</span> <span class="kt">string</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

                <span class="k">public</span> <span class="nf">Save</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ParentActor_ReceiveSaveMessage_StoresModifiedSaveMessageFromChildInRepo</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//arrange
</span>            <span class="n">TestProbeResolver</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">TestProbeResolverSettings</span>
                <span class="p">.</span><span class="n">Empty</span>
                <span class="p">.</span><span class="n">RegisterHandler</span><span class="p">&lt;</span><span class="n">ChildActor</span><span class="p">,</span> <span class="n">ParentActor</span><span class="p">.</span><span class="n">Save</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">ChildActor</span><span class="p">.</span><span class="nf">ModifiedSave</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">()))</span>
                <span class="p">.</span><span class="nf">CreateResolver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IRepository</span><span class="p">&gt;</span> <span class="n">repoMock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IRepository</span><span class="p">&gt;();</span>
            <span class="n">Props</span> <span class="n">props</span> <span class="p">=</span> <span class="n">Props</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ParentActor</span><span class="p">(</span><span class="n">repoMock</span><span class="p">.</span><span class="n">Object</span><span class="p">));</span>
            <span class="n">TestActorRef</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;</span> <span class="n">sut</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">CreateSut</span><span class="p">&lt;</span><span class="n">ParentActor</span><span class="p">&gt;(</span><span class="n">props</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

            <span class="c1">//act
</span>            <span class="n">sut</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="k">new</span> <span class="n">ParentActor</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">));</span>

            <span class="c1">//assert
</span>            <span class="n">repoMock</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">repo</span> <span class="p">=&gt;</span> <span class="n">repo</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="s">"HELLO WORLD"</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Let’s walk through this example:</p>
<ul>
  <li>The <code class="highlighter-rouge">ParentActor</code> in this example doesn’t have a parameterless constructor, so a props object must be given to the <code class="highlighter-rouge">CreateSut</code> method. This props object is used to inject the mock instances into the actor. When the actor is ran in production a genuine implementations would be provided.</li>
  <li>When creating the TestProbeResolverSettings object you can register <em>handlers</em>. A handler is a method that is ran when a particular type of actor receives a particular type of message. This example registers a handler that runs whenever a <code class="highlighter-rouge">ChildActor</code> receives a <code class="highlighter-rouge">ParentActor.Save</code> message. The handler returns an upper case <code class="highlighter-rouge">ChildActor.ModifiedSave</code> message. The returned message is then sent back to the sender actor.</li>
</ul>

<p>The following example demonstrates how to check that an actor sends a message to its parent or supervisor.</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Akka.Actor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Akka.TestKit.Xunit2</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConnelHooley.AkkaTestingHelpers.DI.MediumTests.TestProbeResolverTests.Examples</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Examples3</span> <span class="p">:</span> <span class="n">TestKit</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">DummyActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="nf">DummyActor</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Receive</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">Context</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">());</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">DummyActor_ReceiveStringMessage_SendsUpperCaseStringMessageToSupervisor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//arrange
</span>            <span class="n">TestProbeResolver</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">TestProbeResolverSettings</span>
                <span class="p">.</span><span class="n">Empty</span>
                <span class="p">.</span><span class="nf">CreateResolver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="n">TestActorRef</span><span class="p">&lt;</span><span class="n">DummyActor</span><span class="p">&gt;</span> <span class="n">sut</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">CreateSut</span><span class="p">&lt;</span><span class="n">DummyActor</span><span class="p">&gt;(</span><span class="m">0</span><span class="p">);</span>

            <span class="c1">//act
</span>            <span class="n">sut</span><span class="p">.</span><span class="nf">Tell</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span>

            <span class="c1">//assert
</span>            <span class="n">resolver</span><span class="p">.</span><span class="n">Supervisor</span><span class="p">.</span><span class="nf">ExpectMsg</span><span class="p">(</span><span class="s">"HELLO WORLD"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Let’s walk through this example:</p>
<ul>
  <li>When the resolver creates the sut actor, it creates it with a <code class="highlighter-rouge">TestProbe</code> as its parent, which you can access using the Supervisor property. This ensures you know the sut actor is sending messages to its parent and not the sender.</li>
</ul>

<h1 id="get-it-on-nuget">Get it on NuGet</h1>
<p>You can install it on NuGet using the following command or usual methods:</p>

<blockquote>
  <p>Install-Package ConnelHooley.AkkaTestingHelpers.DI</p>
</blockquote>

<p><a href="https://github.com/connelhooley/AkkaTestingHelpers" class="button-major" target="_BLANK"><i class="fa fa-github fa-fw" aria-hidden="true"></i> View the source code on GitHub</a></p>

<h1 id="whats-next">What’s next</h1>
<p>I wrote the code a few months back so I need to update it to use the latest version of Akka and hopefully target .NET Standard rather than .NET framework. I also need to finish a resolver for integration tests.</p>

<p>I also plan on providing documentation on GitHub and in XML comments in the code.</p>


    </div>
  </div>
  <div id="comments" class="post-comments">
    <div class="post-comments-content">
      
          

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://connelhooley.uk/blog/2017/09/30/introducing-akka-testing-helpers-di';
      this.page.identifier = 'http://connelhooley.uk/blog/2017/09/30/introducing-akka-testing-helpers-di';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://connelhooley.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      
    </div>
  </div>
</article>

    </main>
    <footer class="site-footer">
    <div class="site-footer-content">
        <div class="copy">
            Connel Hooley <i class="fa fa-copyright" aria-hidden="true"></i> 2017
        </div>
        
        <div class="contact">
            <a href="mailto:me@connelhooley.uk" target="_BLANK"><i class="fa fa-envelope fa-fw" aria-hidden="true"></i>&nbsp;Email</a>&nbsp;&bull;
            <a href="https://twitter.com/connel_dev" target="_BLANK"><i class="fa fa-twitter fa-fw" aria-hidden="true"></i>&nbsp;Twitter</a>&nbsp;&bull;
            <a href="http://uk.linkedin.com/in/connelhooley" target="_BLANK"><i class="fa fa-linkedin-square fa-fw" aria-hidden="true"></i>&nbsp;LinkedIn</a>
        </div>
        
    </div>
</footer>
<script src="http://connelhooley.uk/assets/js/jquery-3.1.1.min.js"></script>
<script src="http://connelhooley.uk/assets/js/tether.min.js"></script>
<script src="http://connelhooley.uk/assets/js/bootstrap.min.js"></script>
<script src="http://connelhooley.uk/assets/js/moment.min.js"></script>
<script src="http://connelhooley.uk/assets/js/clipboard.min.js"></script>
<script src="http://connelhooley.uk/assets/js/js.cookie.js"></script>
<script src="http://connelhooley.uk/assets/js/stickyfill.min.js"></script>
<script src="http://connelhooley.uk/assets/js/fixanchorlinks.js"></script>
<script src="http://connelhooley.uk/assets/js/main.js"></script>
  </body>
</html>